<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Ticket Scanner | The Light Park</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://js.stripe.com/terminal/v1/"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a25;
      --border: #2a2a3a;
      --text: #f0f0f5;
      --text-dim: #8888a0;
      --green: #22c55e;
      --red: #ef4444;
      --orange: #f97316;
      --purple: #a855f7;
      --teal: #06d6a0;
      --pink: #ff4fd8;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* ========== SPLASH SCREEN ========== */
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s;
    }
    #splash.hidden { opacity: 0; pointer-events: none; }
    #splash .logo { font-size: 64px; margin-bottom: 16px; }
    #splash .title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    #splash .loading { color: var(--text-dim); }
    
    /* ========== LOGIN SCREEN ========== */
    #loginScreen {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 30px 20px;
    }
    #loginScreen.hidden { display: none; }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .login-header .icon { font-size: 48px; margin-bottom: 12px; }
    .login-header h1 { font-size: 22px; font-weight: 700; }
    .login-header p { color: var(--text-dim); margin-top: 6px; font-size: 14px; }
    
    .venue-selector {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .venue-selector select {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 16px;
      font-weight: 500;
      flex: 1;
      outline: none;
    }
    .venue-selector select option { background: var(--surface); }
    
    .employee-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 24px;
    }
    
    .employee-btn {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px 12px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .employee-btn:active { transform: scale(0.97); }
    .employee-btn.selected { 
      border-color: var(--green); 
      background: rgba(34, 197, 94, 0.1);
    }
    .employee-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: white;
    }
    
    .pin-section { margin-top: auto; }
    .pin-label { 
      color: var(--text-dim); 
      font-size: 13px; 
      margin-bottom: 10px;
      text-align: center;
    }
    .pin-display {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .pin-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--surface2);
      border: 2px solid var(--border);
      transition: all 0.15s;
    }
    .pin-dot.filled { background: var(--green); border-color: var(--green); }
    .pin-dot.error { background: var(--red); border-color: var(--red); animation: shake 0.3s; }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 260px;
      margin: 0 auto;
    }
    .pin-key {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      color: var(--text);
      font-size: 22px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.1s;
    }
    .pin-key:active { transform: scale(0.95); background: var(--surface2); }
    .pin-key.fn { font-size: 13px; color: var(--text-dim); }
    
    .login-error {
      color: var(--red);
      text-align: center;
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
    }
    
    /* ========== MAIN APP ========== */
    #mainApp { display: none; }
    #mainApp.active { display: block; }
    
    /* Header */
    .header {
      background: var(--surface);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: white;
    }
    .header-info h3 { font-size: 14px; font-weight: 600; }
    .header-info p { font-size: 11px; color: var(--text-dim); }
    
    .header-actions { display: flex; gap: 6px; }
    .header-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
    }
    .header-btn.logout { color: var(--red); border-color: rgba(239,68,68,0.3); }
    
    /* Stats Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .stat-item {
      padding: 10px 8px;
      text-align: center;
      border-right: 1px solid var(--border);
    }
    .stat-item:last-child { border-right: none; }
    .stat-value { font-size: 18px; font-weight: 700; color: var(--teal); }
    .stat-value.sales { color: var(--green); }
    .stat-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; margin-top: 2px; }
    
    /* Tab Nav */
    .tab-nav {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      padding: 12px 8px;
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active { color: var(--pink); border-bottom-color: var(--pink); }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* ========== SCANNER TAB ========== */
    .scanner-wrap {
      position: relative;
      height: calc(100vh - 220px);
      min-height: 400px;
    }
    
    #scanner {
      width: 100%;
      height: 100%;
      background: #000;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 220px;
      height: 220px;
      border: 3px solid var(--teal);
      border-radius: 16px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,0.6);
      pointer-events: none;
    }
    
    .scanner-hint {
      position: absolute;
      bottom: 100px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 13px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    
    .scanner-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    .scanner-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
    .scanner-btn.primary { background: var(--purple); color: white; }
    .scanner-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
    
    /* Result Overlay */
    .result-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    .result-overlay.show { display: flex; }
    .result-overlay.valid { background: linear-gradient(135deg, #166534, #22c55e); }
    .result-overlay.invalid { background: linear-gradient(135deg, #991b1b, #ef4444); }
    
    .result-icon { font-size: 100px; margin-bottom: 16px; animation: popIn 0.3s ease; }
    @keyframes popIn {
      0% { transform: scale(0); }
      70% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .result-status { font-size: 32px; font-weight: 700; text-transform: uppercase; }
    .result-message { font-size: 16px; opacity: 0.9; margin: 8px 0 20px; text-align: center; }
    
    .ticket-details {
      background: rgba(255,255,255,0.15);
      border-radius: 14px;
      padding: 16px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }
    .ticket-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
    }
    .ticket-row:last-child { border: none; }
    .ticket-label { opacity: 0.8; }
    .ticket-value { font-weight: 600; }
    
    .addons-section { margin-top: 12px; padding-top: 12px; border-top: 2px solid rgba(255,255,255,0.2); }
    .addons-title { font-size: 13px; font-weight: 600; margin-bottom: 10px; opacity: 0.9; }
    .addon-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    
    .result-btn {
      padding: 14px 40px;
      font-size: 16px;
      font-weight: 700;
      border: none;
      border-radius: 10px;
      background: white;
      color: #333;
      cursor: pointer;
    }
    
    /* Invalid Ticket Actions */
    .invalid-details {
      background: rgba(255,255,255,0.1);
      border-radius: 14px;
      padding: 16px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 16px;
      text-align: left;
    }
    .invalid-reason {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .invalid-info {
      font-size: 13px;
      opacity: 0.85;
      margin-bottom: 4px;
    }
    .invalid-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 320px;
      margin-bottom: 16px;
    }
    .action-btn {
      padding: 14px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .action-btn.primary { background: white; color: #333; }
    .action-btn.secondary { background: rgba(255,255,255,0.2); color: white; }
    .action-btn.warning { background: #f97316; color: white; }
    
    /* ========== SALES TAB ========== */
    #salesTab { padding: 16px; }
    
    .quick-sale-label { font-size: 12px; color: var(--text-dim); margin-bottom: 10px; }
    
    .quick-sales {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .sale-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 12px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
    }
    .sale-btn:active { transform: scale(0.98); background: var(--surface2); }
    .sale-btn .emoji { font-size: 24px; margin-bottom: 6px; }
    .sale-btn .name { font-size: 13px; font-weight: 500; color: var(--text); }
    .sale-btn .price { font-size: 14px; font-weight: 600; color: var(--green); margin-top: 2px; }
    
    .cart-section {
      background: var(--surface);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .cart-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 13px;
      font-weight: 600;
    }
    .cart-clear { background: none; border: none; color: var(--text-dim); font-size: 11px; cursor: pointer; }
    .cart-items { min-height: 50px; }
    .cart-empty { color: var(--text-dim); font-size: 13px; text-align: center; padding: 16px; }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }
    .cart-item:last-child { border: none; }
    .cart-item .remove { background: none; border: none; color: var(--red); font-size: 16px; cursor: pointer; padding: 4px; }
    .cart-total {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
      font-weight: 700;
      padding-top: 10px;
      border-top: 2px solid var(--border);
      margin-top: 10px;
    }
    .cart-total .amount { color: var(--green); }
    
    .checkout-btn {
      width: 100%;
      padding: 14px;
      background: var(--green);
      border: none;
      border-radius: 10px;
      color: var(--bg);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .checkout-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Reader Status */
    .reader-status {
      background: var(--surface);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .reader-info { display: flex; align-items: center; gap: 10px; }
    .reader-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: var(--red);
    }
    .reader-dot.connected { background: var(--green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .reader-label { font-size: 13px; }
    .reader-name { font-weight: 600; }
    .reader-type { color: var(--text-dim); font-size: 11px; }
    .reader-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    
    /* Payment Methods */
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 14px;
    }
    .pay-method-btn {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 14px 12px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }
    .pay-method-btn:active { transform: scale(0.98); }
    .pay-method-btn.selected { border-color: var(--green); background: rgba(34,197,94,0.1); }
    .pay-method-btn .icon { font-size: 24px; margin-bottom: 4px; }
    .pay-method-btn .label { font-size: 12px; font-weight: 500; }
    
    /* Payment Modal */
    .payment-modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }
    .payment-modal.show { display: flex; }
    .payment-modal .icon { font-size: 80px; margin-bottom: 20px; }
    .payment-modal .title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .payment-modal .amount { font-size: 48px; font-weight: 700; color: var(--green); margin-bottom: 8px; }
    .payment-modal .instruction { color: var(--text-dim); font-size: 16px; text-align: center; margin-bottom: 24px; }
    .payment-modal .spinner {
      width: 40px; height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .payment-modal .cancel-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 32px;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    .payment-modal.success .icon { color: var(--green); }
    .payment-modal.error .icon { color: var(--red); }
    
    /* ========== LEADERBOARD TAB ========== */
    #leaderboardTab { padding: 16px; }
    
    .your-rank {
      background: linear-gradient(135deg, var(--pink), var(--purple));
      border-radius: 14px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .your-rank .position { font-size: 40px; font-weight: 700; }
    .your-rank .label { font-size: 12px; opacity: 0.8; }
    .your-rank .sales { margin-top: 6px; font-size: 18px; font-weight: 600; }
    
    .leaderboard-list {
      background: var(--surface);
      border-radius: 12px;
      overflow: hidden;
    }
    .leader-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }
    .leader-item:last-child { border: none; }
    .leader-item.you { background: rgba(255, 79, 216, 0.1); }
    .leader-rank { width: 28px; font-weight: 700; color: var(--text-dim); font-size: 14px; }
    .leader-rank.gold { color: #ffd700; }
    .leader-rank.silver { color: #c0c0c0; }
    .leader-rank.bronze { color: #cd7f32; }
    .leader-avatar {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
      margin-right: 10px;
    }
    .leader-info { flex: 1; }
    .leader-name { font-size: 13px; font-weight: 500; }
    .leader-stats { font-size: 11px; color: var(--text-dim); }
    .leader-total { font-weight: 700; color: var(--green); font-size: 14px; }
    
    /* Footer */
    .compliance-footer {
      padding: 14px;
      text-align: center;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .compliance-footer a { color: var(--text-dim); text-decoration: none; font-size: 10px; margin: 0 8px; }
    .compliance-footer .copy { font-size: 9px; color: var(--text-dim); margin-top: 6px; }
    
    /* ========== PRODUCT CATEGORY TABS ========== */
    .product-category-tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding: 10px 14px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .product-category-tabs::-webkit-scrollbar { display: none; }
    
    .category-tab {
      padding: 8px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-dim);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .category-tab:hover {
      border-color: var(--purple);
      color: var(--text);
    }
    .category-tab.active {
      background: var(--purple);
      border-color: var(--purple);
      color: white;
    }
    
    /* Enhanced quick sales grid */
    .quick-sales {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 12px 14px;
      max-height: 220px;
      overflow-y: auto;
    }
    
    .sale-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 6px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .sale-btn:active { transform: scale(0.95); }
    .sale-btn:hover { border-color: var(--purple); background: rgba(168, 85, 247, 0.1); }
    .sale-btn .emoji { font-size: 22px; }
    .sale-btn .name { font-size: 10px; color: var(--text); text-align: center; line-height: 1.2; }
    .sale-btn .price { font-size: 12px; font-weight: 700; color: var(--teal); }
    .sale-btn .desc { font-size: 8px; color: var(--text-dim); text-align: center; margin-top: 2px; }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash">
    <div class="logo">üéüÔ∏è</div>
    <div class="title">Ticket Scanner</div>
    <div class="loading">Loading...</div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen">
    <div class="login-header">
      <div class="icon">üéüÔ∏è</div>
      <h1>Ticket Scanner</h1>
      <p>Select venue and employee to start</p>
    </div>
    
    <div class="venue-selector">
      <span>üìç</span>
      <select id="venueSelect">
        <option value="katy">Katy</option>
        <option value="spring">Spring</option>
        <option value="selma">Selma</option>
        <option value="missions">Missions</option>
        <option value="arlington">Arlington</option>
        <option value="frisco">Frisco</option>
        <option value="roundrock">Round Rock</option>
        <option value="okc">Oklahoma City</option>
      </select>
    </div>
    
    <div class="employee-grid" id="employeeGrid"></div>
    
    <div class="pin-section">
      <div class="pin-label">Enter your 4-digit PIN</div>
      <div class="pin-display">
        <div class="pin-dot" id="dot0"></div>
        <div class="pin-dot" id="dot1"></div>
        <div class="pin-dot" id="dot2"></div>
        <div class="pin-dot" id="dot3"></div>
      </div>
      <div class="pin-pad">
        <button class="pin-key" onclick="enterPin('1')">1</button>
        <button class="pin-key" onclick="enterPin('2')">2</button>
        <button class="pin-key" onclick="enterPin('3')">3</button>
        <button class="pin-key" onclick="enterPin('4')">4</button>
        <button class="pin-key" onclick="enterPin('5')">5</button>
        <button class="pin-key" onclick="enterPin('6')">6</button>
        <button class="pin-key" onclick="enterPin('7')">7</button>
        <button class="pin-key" onclick="enterPin('8')">8</button>
        <button class="pin-key" onclick="enterPin('9')">9</button>
        <button class="pin-key fn" onclick="clearPin()">Clear</button>
        <button class="pin-key" onclick="enterPin('0')">0</button>
        <button class="pin-key fn" onclick="backspacePin()">‚å´</button>
      </div>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp">
    <header class="header">
      <div class="header-left">
        <div class="header-avatar" id="userAvatar">MG</div>
        <div class="header-info">
          <h3 id="userName">Maria G.</h3>
          <p id="venueName">üìç Katy</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="switchUser()">üîÑ Switch</button>
        <button class="header-btn logout" onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="statScans">0</div>
        <div class="stat-label">Scans</div>
      </div>
      <div class="stat-item">
        <div class="stat-value sales" id="statSales">$0</div>
        <div class="stat-label">Sales</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statCars">0</div>
        <div class="stat-label">Cars</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="statPoints">0</div>
        <div class="stat-label">Points</div>
      </div>
    </div>
    
    <nav class="tab-nav">
      <button class="tab-btn active" onclick="showTab('scanner')">üì∑ Scan</button>
      <button class="tab-btn" onclick="showTab('sales')">üí≥ Sales</button>
      <button class="tab-btn" onclick="showTab('leaderboard')">üèÜ Leaders</button>
    </nav>
    
    <!-- Scanner Tab -->
    <div class="tab-content active" id="scannerTab">
      <div class="scanner-wrap">
        <div id="scanner"></div>
        <div class="scanner-overlay"></div>
        <div class="scanner-hint">Point camera at QR code</div>
        <div class="scanner-controls">
          <button class="scanner-btn secondary" onclick="manualEntry()">‚å®Ô∏è Manual</button>
          <button class="scanner-btn primary" onclick="simulateScan()">üì± Demo</button>
        </div>
      </div>
    </div>
    
    <!-- Sales Tab -->
    <div class="tab-content" id="salesTab">
      <!-- Reader Status -->
      <div class="reader-status">
        <div class="reader-info">
          <div class="reader-dot" id="readerDot"></div>
          <div class="reader-label">
            <div class="reader-name" id="readerName">No Reader</div>
            <div class="reader-type" id="readerType">Tap to connect</div>
          </div>
        </div>
        <button class="reader-btn" onclick="connectReader()">‚öôÔ∏è Setup</button>
      </div>
      
      <!-- Product Category Tabs -->
      <div class="product-category-tabs" id="productCategoryTabs"></div>
      
      <div class="quick-sales" id="quickSales"></div>
      
      <div class="cart-section">
        <div class="cart-header">
          <span>üõí Cart</span>
          <button class="cart-clear" onclick="clearCart()">Clear</button>
        </div>
        <div class="cart-items" id="cartItems">
          <div class="cart-empty">Tap items to add</div>
        </div>
        <div class="cart-total">
          <span>Total</span>
          <span class="amount" id="cartTotal">$0.00</span>
        </div>
      </div>
      
      <!-- Payment Method -->
      <div class="quick-sale-label" style="margin-top:14px">Payment Method</div>
      <div class="payment-methods">
        <button class="pay-method-btn selected" onclick="selectPayMethod('tap')" id="payTap">
          <div class="icon">üì±</div>
          <div class="label">Tap to Pay</div>
        </button>
        <button class="pay-method-btn" onclick="selectPayMethod('reader')" id="payReader">
          <div class="icon">üí≥</div>
          <div class="label">Card Reader</div>
        </button>
      </div>
      
      <button class="checkout-btn" id="checkoutBtn" onclick="checkout()" disabled>
        üí≥ Charge $0.00
      </button>
    </div>
    
    <!-- Leaderboard Tab -->
    <div class="tab-content" id="leaderboardTab">
      <div class="your-rank">
        <div class="position" id="yourRank">#-</div>
        <div class="label">Your Position Today</div>
        <div class="sales" id="yourTotal">$0.00</div>
      </div>
      <div class="leaderboard-list" id="leaderboardList"></div>
    </div>
    
    <footer class="compliance-footer">
      <a href="privacy-policy.html">Privacy</a>
      <a href="terms-of-service.html">Terms</a>
      <a href="refund-policy.html">Refunds</a>
      <div class="copy">¬© 2026 The Light Park ¬∑ Payments by Stripe</div>
    </footer>
  </div>

  <!-- Result Overlay -->
  <div class="result-overlay" id="resultOverlay">
    <div class="result-icon" id="resultIcon">‚úÖ</div>
    <div class="result-status" id="resultStatus">VALID</div>
    <div class="result-message" id="resultMessage">Welcome to The Light Park!</div>
    
    <div class="ticket-details" id="ticketDetails">
      <div class="ticket-row">
        <span class="ticket-label">Ticket Type</span>
        <span class="ticket-value" id="ticketType">General Admission</span>
      </div>
      <div class="ticket-row">
        <span class="ticket-label">Valid For</span>
        <span class="ticket-value" id="ticketDate">Feb 6, 2026</span>
      </div>
      <div class="ticket-row">
        <span class="ticket-label">Vehicle</span>
        <span class="ticket-value" id="ticketVehicle">1 Car</span>
      </div>
      <div class="ticket-row">
        <span class="ticket-label">Order #</span>
        <span class="ticket-value" id="ticketOrder">TLP-28491</span>
      </div>
      <div class="addons-section" id="addonsSection">
        <div class="addons-title">üéÅ Pre-Purchased Add-Ons</div>
        <div id="addonsList"></div>
      </div>
    </div>
    
    <!-- Invalid Ticket Details -->
    <div class="invalid-details" id="invalidDetails" style="display:none">
      <div class="invalid-reason" id="invalidReason">
        <span>‚ö†Ô∏è</span>
        <span id="invalidReasonText">Reason</span>
      </div>
      <div class="invalid-info" id="invalidInfo1"></div>
      <div class="invalid-info" id="invalidInfo2"></div>
    </div>
    
    <!-- Action Buttons -->
    <div class="invalid-actions" id="invalidActions" style="display:none"></div>
    
    <button class="result-btn" onclick="dismissResult()">Scan Next</button>
  </div>

  <!-- Payment Modal -->
  <div class="payment-modal" id="paymentModal">
    <div class="icon" id="payModalIcon">üì±</div>
    <div class="amount" id="payModalAmount">$0.00</div>
    <div class="title" id="payModalTitle">Ready to Pay</div>
    <div class="instruction" id="payModalInstruction">Hold card or phone near device</div>
    <div class="spinner" id="payModalSpinner"></div>
    <button class="cancel-btn" onclick="cancelPayment()">Cancel</button>
  </div>

  <!-- Reader Setup Modal -->
  <div class="payment-modal" id="readerModal">
    <div class="icon">‚öôÔ∏è</div>
    <div class="title">Connect Card Reader</div>
    <div class="instruction" id="readerInstruction">Searching for readers...</div>
    <div class="spinner" id="readerSpinner"></div>
    <div id="readerList" style="width:100%;max-width:300px;margin-bottom:20px"></div>
    <button class="cancel-btn" onclick="closeReaderModal()">Close</button>
  </div>

  <script>
    // ========== DATA ==========
    const employees = [
      { id: 1, name: 'Maria G.', initials: 'MG', pin: '1234', color: '#ff4fd8' },
      { id: 2, name: 'Jason R.', initials: 'JR', pin: '5678', color: '#a855f7' },
      { id: 3, name: 'Sarah C.', initials: 'SC', pin: '9012', color: '#06d6a0' },
      { id: 4, name: 'Eddie M.', initials: 'EM', pin: '3456', color: '#f97316' },
      { id: 5, name: 'Citlaly V.', initials: 'CV', pin: '7890', color: '#3b82f6' },
      { id: 6, name: 'Manager', initials: 'üëë', pin: '0000', color: '#eab308' },
    ];
    
    // Product categories for on-site add-on sales
    const productCategories = {
      popular: { name: '‚≠ê Popular', color: '#a855f7' },
      food: { name: 'üç´ Food & Drinks', color: '#f97316' },
      merch: { name: 'üéÅ Merchandise', color: '#06d6a0' },
      bundles: { name: 'üéÑ Bundles', color: '#eab308' }
    };
    
    const products = [
      // Popular (best sellers)
      { id: 1, name: 'Hot Cocoa', price: 5.00, emoji: '‚òï', category: 'popular' },
      { id: 2, name: "S'mores Kit", price: 8.00, emoji: 'üî•', category: 'popular' },
      { id: 3, name: 'Light Wand', price: 12.00, emoji: 'ü™Ñ', category: 'popular' },
      { id: 4, name: 'Popcorn', price: 6.00, emoji: 'üçø', category: 'popular' },
      
      // Food & Drinks
      { id: 10, name: 'Hot Cocoa', price: 5.00, emoji: '‚òï', category: 'food' },
      { id: 11, name: 'Apple Cider', price: 5.00, emoji: 'üçé', category: 'food' },
      { id: 12, name: 'Coffee', price: 4.00, emoji: '‚òï', category: 'food' },
      { id: 13, name: 'Hot Tea', price: 3.50, emoji: 'üçµ', category: 'food' },
      { id: 14, name: 'Water Bottle', price: 3.00, emoji: 'üíß', category: 'food' },
      { id: 15, name: "S'mores Kit", price: 8.00, emoji: 'üî•', category: 'food' },
      { id: 16, name: 'Popcorn', price: 6.00, emoji: 'üçø', category: 'food' },
      { id: 17, name: 'Cotton Candy', price: 7.00, emoji: 'üç≠', category: 'food' },
      { id: 18, name: 'Churros', price: 6.00, emoji: 'ü•ñ', category: 'food' },
      { id: 19, name: 'Candy Cane', price: 2.00, emoji: 'üç¨', category: 'food' },
      { id: 20, name: 'Hot Chocolate Bomb', price: 8.00, emoji: 'üí£', category: 'food' },
      
      // Merchandise
      { id: 30, name: 'Light Wand', price: 12.00, emoji: 'ü™Ñ', category: 'merch' },
      { id: 31, name: 'Glow Necklace', price: 5.00, emoji: 'üí´', category: 'merch' },
      { id: 32, name: 'Magic Glasses', price: 6.00, emoji: 'üëì', category: 'merch' },
      { id: 33, name: 'Plush Toy', price: 20.00, emoji: 'üß∏', category: 'merch' },
      { id: 34, name: 'Santa Hat', price: 15.00, emoji: 'üéÖ', category: 'merch' },
      { id: 35, name: 'Reindeer Antlers', price: 12.00, emoji: 'ü¶å', category: 'merch' },
      { id: 36, name: 'Light Park T-Shirt', price: 25.00, emoji: 'üëï', category: 'merch' },
      { id: 37, name: 'Ornament', price: 10.00, emoji: 'üéÑ', category: 'merch' },
      { id: 38, name: 'Snow Globe', price: 18.00, emoji: 'üîÆ', category: 'merch' },
      { id: 39, name: 'Blanket', price: 30.00, emoji: 'üõèÔ∏è', category: 'merch' },
      
      // Bundles (reward redemptions)
      { id: 70, name: 'Blitzen Bundle', price: 29.99, emoji: '‚ö°', category: 'bundles', desc: 'Cocoa + S\'mores + Wand' },
      { id: 71, name: 'Dasher Pass', price: 19.99, emoji: 'ü¶å', category: 'bundles', desc: 'Fast Pass + Cocoa' },
      { id: 72, name: 'Family Fun Pack', price: 39.99, emoji: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', category: 'bundles', desc: '4 Cocoas + Popcorn + Wand' },
      { id: 73, name: 'VIP Upgrade', price: 29.99, emoji: 'üëë', category: 'bundles', desc: 'Front of line access' },
      { id: 74, name: 'Kids Bundle', price: 15.00, emoji: 'üßí', category: 'bundles', desc: 'Wand + Glow Necklace + Candy' },
    ];
    
    let activeProductCategory = 'popular';
    
    const DEMO_TICKETS = [
      // Valid tickets
      { valid: true, type: 'General Admission', date: 'Feb 6, 2026', vehicle: '1 Car', order: 'TLP-28491', addons: [{ icon: '‚òï', name: 'Hot Cocoa', qty: 2 }] },
      { valid: true, type: 'Season Pass - Gold', date: 'All Season', vehicle: '1 Car + Fast Pass', order: 'TLP-SP-1042', addons: [] },
      { valid: true, type: 'VIP Experience', date: 'Feb 6, 2026', vehicle: '1 Car', order: 'TLP-VIP-392', addons: [{ icon: 'üéÅ', name: 'Blitzen Bundle', qty: 1 }] },
      
      // Invalid: Wrong date
      { 
        valid: false, 
        errorType: 'wrong_date',
        reason: 'Wrong Date',
        info1: 'Ticket valid for: Feb 5, 2026',
        info2: 'Order #TLP-27833 ¬∑ General Admission',
        order: 'TLP-27833',
        actions: [
          { label: 'üìÖ Change Date ($0)', type: 'primary', action: 'changeDate' },
          { label: 'üéüÔ∏è Buy New Ticket', type: 'secondary', action: 'buyTicket' },
          { label: 'üëë Manager Override', type: 'warning', action: 'override' }
        ]
      },
      
      // Invalid: Already scanned
      { 
        valid: false, 
        errorType: 'already_scanned',
        reason: 'Already Scanned',
        info1: 'First scan: Today at 5:42 PM',
        info2: 'Order #TLP-28102 ¬∑ General Admission',
        order: 'TLP-28102',
        actions: [
          { label: 'üîç View Scan History', type: 'secondary', action: 'viewHistory' },
          { label: 'üëë Manager Override', type: 'warning', action: 'override' },
          { label: 'üìû Call Support', type: 'secondary', action: 'callSupport' }
        ]
      },
      
      // Invalid: Expired ticket
      { 
        valid: false, 
        errorType: 'expired',
        reason: 'Ticket Expired',
        info1: 'Season ended: Jan 5, 2026',
        info2: 'Order #TLP-25001 ¬∑ 2025 Season Pass',
        order: 'TLP-25001',
        actions: [
          { label: 'üéüÔ∏è Buy 2026 Season Pass', type: 'primary', action: 'buySeasonPass' },
          { label: 'üéüÔ∏è Buy Tonight\'s Ticket', type: 'secondary', action: 'buyTicket' }
        ]
      },
      
      // Invalid: Unrecognized code
      { 
        valid: false, 
        errorType: 'invalid_code',
        reason: 'Invalid QR Code',
        info1: 'This code is not recognized',
        info2: 'May be damaged, fake, or from another venue',
        order: 'UNKNOWN',
        actions: [
          { label: '‚å®Ô∏è Enter Code Manually', type: 'primary', action: 'manualEntry' },
          { label: 'üîç Look Up by Email', type: 'secondary', action: 'lookupEmail' },
          { label: 'üìû Call Support', type: 'secondary', action: 'callSupport' }
        ]
      },
      
      // Invalid: Refunded ticket
      { 
        valid: false, 
        errorType: 'refunded',
        reason: 'Ticket Refunded',
        info1: 'This ticket was refunded on Feb 3, 2026',
        info2: 'Order #TLP-27500 ¬∑ General Admission',
        order: 'TLP-27500',
        actions: [
          { label: 'üéüÔ∏è Buy New Ticket', type: 'primary', action: 'buyTicket' },
          { label: 'üìû Call Support', type: 'secondary', action: 'callSupport' }
        ]
      }
    ];
    
    const leaderboardData = [
      { name: 'Sarah C.', initials: 'SC', color: '#06d6a0', scans: 47, sales: 285.00 },
      { name: 'Maria G.', initials: 'MG', color: '#ff4fd8', scans: 42, sales: 247.50 },
      { name: 'Jason R.', initials: 'JR', color: '#a855f7', scans: 38, sales: 192.00 },
      { name: 'Eddie M.', initials: 'EM', color: '#f97316', scans: 31, sales: 156.00 },
      { name: 'Citlaly V.', initials: 'CV', color: '#3b82f6', scans: 28, sales: 134.50 },
    ];
    
    // ========== STATE ==========
    let currentUser = null;
    let currentVenue = 'katy';
    let selectedEmployee = null;
    let enteredPin = '';
    let cart = [];
    let stats = { scans: 0, sales: 0, cars: 0, points: 0 };
    let html5QrCode = null;
    
    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => document.getElementById('splash').classList.add('hidden'), 1000);
      renderEmployeeGrid();
      renderCategoryTabs();
      renderProducts();
      renderLeaderboard();
      checkSavedSession();
    });
    
    function checkSavedSession() {
      const saved = localStorage.getItem('tlp_scanner_session');
      if (saved) {
        const session = JSON.parse(saved);
        if (Date.now() - session.loginTime < 8 * 60 * 60 * 1000) {
          currentUser = employees.find(e => e.id === session.empId);
          currentVenue = session.venue || 'katy';
          stats = session.stats || { scans: 0, sales: 0, cars: 0, points: 0 };
          if (currentUser) showMainApp();
        }
      }
    }
    
    // ========== LOGIN ==========
    function renderEmployeeGrid() {
      document.getElementById('employeeGrid').innerHTML = employees.map(emp => `
        <button class="employee-btn" data-id="${emp.id}" onclick="selectEmployee(${emp.id})">
          <div class="employee-avatar" style="background:${emp.color}">${emp.initials}</div>
          <span>${emp.name}</span>
        </button>
      `).join('');
    }
    
    function selectEmployee(id) {
      selectedEmployee = employees.find(e => e.id === id);
      document.querySelectorAll('.employee-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.id) === id);
      });
      clearPin();
      document.getElementById('loginError').textContent = '';
    }
    
    function enterPin(digit) {
      if (enteredPin.length >= 4) return;
      enteredPin += digit;
      updatePinDots();
      if (enteredPin.length === 4) validateLogin();
    }
    
    function clearPin() {
      enteredPin = '';
      updatePinDots();
    }
    
    function backspacePin() {
      enteredPin = enteredPin.slice(0, -1);
      updatePinDots();
    }
    
    function updatePinDots() {
      for (let i = 0; i < 4; i++) {
        const dot = document.getElementById('dot' + i);
        dot.classList.toggle('filled', i < enteredPin.length);
        dot.classList.remove('error');
      }
    }
    
    function validateLogin() {
      if (!selectedEmployee) {
        document.getElementById('loginError').textContent = 'Select your name first';
        shakePin();
        return;
      }
      if (enteredPin === selectedEmployee.pin) {
        currentUser = selectedEmployee;
        currentVenue = document.getElementById('venueSelect').value;
        stats = { scans: 0, sales: 0, cars: 0, points: 0 };
        saveSession();
        showMainApp();
      } else {
        document.getElementById('loginError').textContent = 'Wrong PIN';
        shakePin();
        setTimeout(clearPin, 400);
      }
    }
    
    function shakePin() {
      document.querySelectorAll('.pin-dot').forEach(dot => dot.classList.add('error'));
    }
    
    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('active');
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userAvatar').textContent = currentUser.initials;
      document.getElementById('userAvatar').style.background = currentUser.color;
      document.getElementById('venueName').textContent = 'üìç ' + currentVenue.charAt(0).toUpperCase() + currentVenue.slice(1);
      updateStats();
      initScanner();
      initStripeTerminal();
    }
    
    function switchUser() {
      if (confirm('Switch to another employee?')) logout(false);
    }
    
    function logout(clear = true) {
      if (clear) localStorage.removeItem('tlp_scanner_session');
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
      currentUser = null;
      selectedEmployee = null;
      enteredPin = '';
      cart = [];
      document.getElementById('mainApp').classList.remove('active');
      document.getElementById('loginScreen').classList.remove('hidden');
      document.querySelectorAll('.employee-btn').forEach(btn => btn.classList.remove('selected'));
      clearPin();
    }
    
    function saveSession() {
      localStorage.setItem('tlp_scanner_session', JSON.stringify({
        empId: currentUser.id,
        venue: currentVenue,
        loginTime: Date.now(),
        stats: stats
      }));
    }
    
    // ========== TABS ==========
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId + 'Tab').classList.add('active');
      event.target.classList.add('active');
    }
    
    // ========== SCANNER ==========
    async function initScanner() {
      try {
        html5QrCode = new Html5Qrcode('scanner');
        await html5QrCode.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: { width: 220, height: 220 } },
          onScanSuccess
        );
      } catch (err) {
        console.log('Camera not available:', err);
      }
    }
    
    function onScanSuccess(decodedText) {
      if (navigator.vibrate) navigator.vibrate(100);
      validateTicket(decodedText);
    }
    
    function validateTicket(code) {
      const ticket = DEMO_TICKETS[Math.floor(Math.random() * DEMO_TICKETS.length)];
      stats.scans++;
      
      if (ticket.valid) {
        stats.cars++;
        stats.points += 10;
      }
      
      updateStats();
      saveSession();
      showResult(ticket);
    }
    
    function showResult(ticket) {
      const overlay = document.getElementById('resultOverlay');
      const invalidDetails = document.getElementById('invalidDetails');
      const invalidActions = document.getElementById('invalidActions');
      
      // Hide invalid sections by default
      invalidDetails.style.display = 'none';
      invalidActions.style.display = 'none';
      
      if (ticket.valid) {
        overlay.className = 'result-overlay show valid';
        document.getElementById('resultIcon').textContent = '‚úÖ';
        document.getElementById('resultStatus').textContent = 'VALID';
        document.getElementById('resultMessage').textContent = 'Welcome to The Light Park!';
        document.getElementById('ticketDetails').style.display = 'block';
        document.getElementById('ticketType').textContent = ticket.type;
        document.getElementById('ticketDate').textContent = ticket.date;
        document.getElementById('ticketVehicle').textContent = ticket.vehicle;
        document.getElementById('ticketOrder').textContent = ticket.order;
        
        if (ticket.addons?.length) {
          document.getElementById('addonsSection').style.display = 'block';
          document.getElementById('addonsList').innerHTML = ticket.addons.map(a => 
            `<div class="addon-item"><span>${a.icon}</span><span>${a.name}</span><span>√ó${a.qty}</span></div>`
          ).join('');
        } else {
          document.getElementById('addonsSection').style.display = 'none';
        }
        
        setTimeout(() => overlay.classList.contains('show') && dismissResult(), 4000);
      } else {
        overlay.className = 'result-overlay show invalid';
        document.getElementById('resultIcon').textContent = '‚ùå';
        document.getElementById('resultStatus').textContent = 'INVALID';
        document.getElementById('resultMessage').textContent = '';
        document.getElementById('ticketDetails').style.display = 'none';
        
        // Show detailed invalid info
        invalidDetails.style.display = 'block';
        document.getElementById('invalidReasonText').textContent = ticket.reason || 'Unknown Error';
        document.getElementById('invalidInfo1').textContent = ticket.info1 || '';
        document.getElementById('invalidInfo2').textContent = ticket.info2 || '';
        
        // Show action buttons
        if (ticket.actions && ticket.actions.length) {
          invalidActions.style.display = 'flex';
          invalidActions.innerHTML = ticket.actions.map(a => 
            `<button class="action-btn ${a.type}" onclick="handleInvalidAction('${a.action}', '${ticket.order}')">${a.label}</button>`
          ).join('');
        }
      }
    }
    
    // Handle invalid ticket actions
    function handleInvalidAction(action, orderId) {
      dismissResult();
      
      switch(action) {
        case 'changeDate':
          alert(`Opening date change for order ${orderId}...\n\nIn production: Opens "Manage My Order" page`);
          break;
        case 'buyTicket':
          alert('Opening ticket purchase...\n\nIn production: Opens ticketing page');
          break;
        case 'buySeasonPass':
          alert('Opening season pass purchase...\n\nIn production: Opens season pass page');
          break;
        case 'override':
          const pin = prompt('Enter manager PIN to override:');
          if (pin === '0000') {
            alert('‚úÖ Manager override approved\n\nGuest may enter.');
            stats.scans++;
            stats.cars++;
            updateStats();
            saveSession();
          } else if (pin) {
            alert('‚ùå Invalid manager PIN');
          }
          break;
        case 'viewHistory':
          alert(`Scan History for ${orderId}:\n\n‚Ä¢ Feb 6, 5:42 PM - Gate A (Maria G.)\n\nIn production: Shows full scan history`);
          break;
        case 'lookupEmail':
          const email = prompt('Enter customer email:');
          if (email) {
            alert(`Looking up tickets for ${email}...\n\nIn production: Searches order database`);
          }
          break;
        case 'callSupport':
          if (confirm('Call Light Park Support?\n\n(555) 123-4567')) {
            window.location.href = 'tel:+15551234567';
          }
          break;
        case 'manualEntry':
          manualEntry();
          break;
        default:
          alert(`Action: ${action}\n\nIn production: Handles this action`);
      }
    }
    
    function dismissResult() {
      document.getElementById('resultOverlay').classList.remove('show');
    }
    
    function simulateScan() { validateTicket('DEMO'); }
    
    function manualEntry() {
      const code = prompt('Enter ticket code:');
      if (code) validateTicket(code);
    }
    
    // ========== SALES ==========
    function renderCategoryTabs() {
      const container = document.getElementById('productCategoryTabs');
      container.innerHTML = Object.entries(productCategories).map(([key, cat]) => `
        <button class="category-tab ${activeProductCategory === key ? 'active' : ''}" 
                onclick="selectProductCategory('${key}')"
                style="${activeProductCategory === key ? `background: ${cat.color}; border-color: ${cat.color};` : ''}">
          ${cat.name}
        </button>
      `).join('');
    }
    
    function selectProductCategory(category) {
      activeProductCategory = category;
      renderCategoryTabs();
      renderProducts();
    }
    
    function renderProducts() {
      const filtered = products.filter(p => p.category === activeProductCategory);
      document.getElementById('quickSales').innerHTML = filtered.map(p => `
        <button class="sale-btn" onclick="addToCart(${p.id})">
          <div class="emoji">${p.emoji}</div>
          <div class="name">${p.name}</div>
          <div class="price">$${p.price.toFixed(2)}</div>
          ${p.desc ? `<div class="desc">${p.desc}</div>` : ''}
        </button>
      `).join('');
    }
    
    function addToCart(id) {
      const product = products.find(p => p.id === id);
      cart.push({...product});
      renderCart();
    }
    
    function removeFromCart(i) {
      cart.splice(i, 1);
      renderCart();
    }
    
    function clearCart() {
      cart = [];
      renderCart();
    }
    
    function renderCart() {
      const container = document.getElementById('cartItems');
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      
      if (cart.length === 0) {
        container.innerHTML = '<div class="cart-empty">Tap items to add</div>';
      } else {
        container.innerHTML = cart.map((item, i) => `
          <div class="cart-item">
            <span>${item.emoji} ${item.name}</span>
            <span>$${item.price.toFixed(2)}</span>
            <button class="remove" onclick="removeFromCart(${i})">√ó</button>
          </div>
        `).join('');
      }
      
      document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
      document.getElementById('checkoutBtn').textContent = `üí≥ Charge $${total.toFixed(2)}`;
      document.getElementById('checkoutBtn').disabled = cart.length === 0;
    }
    
    // ========== STRIPE TERMINAL ==========
    let terminal = null;
    let connectedReader = null;
    let selectedPayMethod = 'tap';
    
    // Initialize Stripe Terminal (call after login)
    async function initStripeTerminal() {
      // In production, fetch connection token from your server
      terminal = StripeTerminal.create({
        onFetchConnectionToken: fetchConnectionToken,
        onUnexpectedReaderDisconnect: handleDisconnect,
      });
      
      // Check for saved reader
      const savedReader = localStorage.getItem('tlp_stripe_reader');
      if (savedReader) {
        const reader = JSON.parse(savedReader);
        updateReaderUI(reader.label, reader.device_type, true);
      }
    }
    
    // API Base URL - change for production
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : 'https://thelightparkapp.com';
    
    async function fetchConnectionToken() {
      try {
        const response = await fetch(`${API_BASE}/api/stripe/connection-token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        if (data.error) {
          console.error('Connection token error:', data.error);
          // Fall back to simulated mode
          return 'simulated_token';
        }
        return data.secret;
      } catch (err) {
        console.error('Failed to fetch connection token:', err);
        // Fall back to simulated mode for demo
        return 'simulated_token';
      }
    }
    
    function handleDisconnect() {
      connectedReader = null;
      updateReaderUI('Disconnected', 'Tap to reconnect', false);
    }
    
    function updateReaderUI(name, type, connected) {
      document.getElementById('readerName').textContent = name || 'No Reader';
      document.getElementById('readerType').textContent = type || 'Tap to connect';
      document.getElementById('readerDot').classList.toggle('connected', connected);
    }
    
    async function connectReader() {
      document.getElementById('readerModal').classList.add('show');
      document.getElementById('readerInstruction').textContent = 'Searching for readers...';
      document.getElementById('readerSpinner').style.display = 'block';
      document.getElementById('readerList').innerHTML = '';
      
      let realReaders = [];
      
      // Try to discover real readers if Terminal is initialized
      if (terminal) {
        try {
          // Discover Bluetooth readers
          const discoverResult = await terminal.discoverReaders({
            simulated: false,
            discoveryMethod: 'bluetoothScan'
          });
          
          if (!discoverResult.error && discoverResult.discoveredReaders) {
            realReaders = discoverResult.discoveredReaders;
          }
        } catch (err) {
          console.log('Reader discovery error (falling back to simulated):', err);
        }
      }
      
      document.getElementById('readerSpinner').style.display = 'none';
      document.getElementById('readerInstruction').textContent = 
        realReaders.length > 0 ? 'Select a reader:' : 'Select payment method:';
      
      // Build reader list HTML
      let readerHtml = '';
      
      // Add real discovered readers
      realReaders.forEach((reader, idx) => {
        readerHtml += `
          <button onclick="connectToReader(${idx})" style="width:100%;padding:14px;margin:6px 0;background:var(--surface);border:2px solid var(--green);border-radius:8px;color:var(--text);cursor:pointer;text-align:left">
            <div style="font-weight:600">üí≥ ${reader.label || reader.serial_number}</div>
            <div style="font-size:12px;color:var(--text-dim)">${reader.device_type} ¬∑ ${reader.status}</div>
          </button>
        `;
      });
      
      // Always show simulated/tap options
      readerHtml += `
        <button onclick="selectReader('tap')" style="width:100%;padding:14px;margin:6px 0;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left">
          <div style="font-weight:600">üì± Tap to Pay on iPhone</div>
          <div style="font-size:12px;color:var(--text-dim)">Use this device (requires Stripe app)</div>
        </button>
        <button onclick="selectReader('simulated')" style="width:100%;padding:14px;margin:6px 0;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;text-align:left">
          <div style="font-weight:600">üß™ Demo Mode</div>
          <div style="font-size:12px;color:var(--text-dim)">Simulated payments for testing</div>
        </button>
      `;
      
      document.getElementById('readerList').innerHTML = readerHtml;
      
      // Store discovered readers for connection
      window.discoveredReaders = realReaders;
    }
    
    async function connectToReader(idx) {
      const reader = window.discoveredReaders[idx];
      if (!reader || !terminal) {
        alert('Reader not available');
        return;
      }
      
      document.getElementById('readerInstruction').textContent = 'Connecting...';
      document.getElementById('readerSpinner').style.display = 'block';
      document.getElementById('readerList').innerHTML = '';
      
      try {
        const connectResult = await terminal.connectReader(reader);
        if (connectResult.error) {
          throw new Error(connectResult.error.message);
        }
        
        connectedReader = {
          label: reader.label || reader.serial_number,
          device_type: reader.device_type,
          reader: connectResult.reader
        };
        localStorage.setItem('tlp_stripe_reader', JSON.stringify({
          label: connectedReader.label,
          device_type: connectedReader.device_type
        }));
        updateReaderUI(connectedReader.label, connectedReader.device_type, true);
        closeReaderModal();
      } catch (err) {
        alert('Failed to connect: ' + err.message);
        document.getElementById('readerSpinner').style.display = 'none';
        connectReader(); // Show list again
      }
    }
    
    async function selectReader(type) {
      const readers = {
        tap: { label: 'Tap to Pay', device_type: 'iPhone NFC' },
        m2: { label: 'Stripe M2', device_type: 'Bluetooth Reader' },
        wisepad: { label: 'WisePad 3', device_type: 'Bluetooth Reader' }
      };
      
      connectedReader = readers[type];
      localStorage.setItem('tlp_stripe_reader', JSON.stringify(connectedReader));
      updateReaderUI(connectedReader.label, connectedReader.device_type, true);
      closeReaderModal();
    }
    
    function closeReaderModal() {
      document.getElementById('readerModal').classList.remove('show');
    }
    
    function selectPayMethod(method) {
      selectedPayMethod = method;
      document.querySelectorAll('.pay-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById(method === 'tap' ? 'payTap' : 'payReader').classList.add('selected');
    }
    
    function checkout() {
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      if (total <= 0) return;
      
      // Show payment modal
      const modal = document.getElementById('paymentModal');
      modal.classList.remove('success', 'error');
      modal.classList.add('show');
      
      document.getElementById('payModalAmount').textContent = '$' + total.toFixed(2);
      document.getElementById('payModalIcon').textContent = selectedPayMethod === 'tap' ? 'üì±' : 'üí≥';
      document.getElementById('payModalTitle').textContent = 'Ready to Pay';
      document.getElementById('payModalInstruction').textContent = 
        selectedPayMethod === 'tap' 
          ? 'Hold card or phone near device' 
          : 'Insert or tap card on reader';
      document.getElementById('payModalSpinner').style.display = 'block';
      
      // Process payment (simulated for demo)
      processPayment(total);
    }
    
    async function processPayment(amount) {
      const modal = document.getElementById('paymentModal');
      const amountCents = Math.round(amount * 100);
      
      try {
        // Step 1: Create PaymentIntent on server
        document.getElementById('payModalInstruction').textContent = 'Creating payment...';
        
        const piResponse = await fetch(`${API_BASE}/api/stripe/create-payment-intent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amountCents,
            description: `Light Park - ${cart.map(i => i.name).join(', ')}`,
            metadata: {
              employee: currentUser?.name || 'Unknown',
              venue: currentVenue,
              items: cart.map(i => i.name).join(', ')
            }
          })
        });
        
        const paymentIntent = await piResponse.json();
        
        if (paymentIntent.error) {
          throw new Error(paymentIntent.error.message || 'Failed to create payment');
        }
        
        // Step 2: Collect payment method via Terminal
        document.getElementById('payModalInstruction').textContent = 
          selectedPayMethod === 'tap' 
            ? 'Hold card or phone near device...' 
            : 'Insert or tap card on reader...';
        
        // If we have a real Terminal connection, collect payment
        if (terminal && connectedReader) {
          const collectResult = await terminal.collectPaymentMethod(paymentIntent.client_secret);
          
          if (collectResult.error) {
            throw new Error(collectResult.error.message);
          }
          
          // Step 3: Confirm the payment
          document.getElementById('payModalInstruction').textContent = 'Processing...';
          const confirmResult = await terminal.processPayment(collectResult.paymentIntent);
          
          if (confirmResult.error) {
            throw new Error(confirmResult.error.message);
          }
          
          // Payment successful!
          paymentSuccess(amount);
        } else {
          // Simulated mode (no real Terminal connected)
          console.log('Simulated payment mode - no Terminal connected');
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          // 90% success rate for simulation
          if (Math.random() > 0.1) {
            paymentSuccess(amount);
          } else {
            throw new Error('Card declined (simulated)');
          }
        }
        
      } catch (err) {
        console.error('Payment error:', err);
        document.getElementById('payModalSpinner').style.display = 'none';
        modal.classList.add('error');
        document.getElementById('payModalIcon').textContent = '‚ùå';
        document.getElementById('payModalTitle').textContent = 'Payment Failed';
        document.getElementById('payModalInstruction').textContent = err.message || 'Please try again';
      }
    }
    
    function paymentSuccess(amount) {
      const modal = document.getElementById('paymentModal');
      document.getElementById('payModalSpinner').style.display = 'none';
      
      modal.classList.add('success');
      document.getElementById('payModalIcon').textContent = '‚úÖ';
      document.getElementById('payModalTitle').textContent = 'Payment Successful!';
      document.getElementById('payModalInstruction').textContent = 'Receipt sent to customer';
      
      // Update stats
      stats.sales += amount;
      stats.points += Math.floor(amount);
      updateStats();
      saveSession();
      
      // Vibrate on success
      if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
      
      // Auto-close and clear cart
      setTimeout(() => {
        modal.classList.remove('show');
        clearCart();
      }, 2000);
    }
    
    function cancelPayment() {
      document.getElementById('paymentModal').classList.remove('show');
    }
    
    // ========== LEADERBOARD ==========
    function renderLeaderboard() {
      const list = document.getElementById('leaderboardList');
      list.innerHTML = leaderboardData.map((p, i) => {
        const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const isYou = currentUser && p.name === currentUser.name;
        return `
          <div class="leader-item ${isYou ? 'you' : ''}">
            <div class="leader-rank ${rankClass}">#${i + 1}</div>
            <div class="leader-avatar" style="background:${p.color}">${p.initials}</div>
            <div class="leader-info">
              <div class="leader-name">${p.name}${isYou ? ' (You)' : ''}</div>
              <div class="leader-stats">${p.scans} scans</div>
            </div>
            <div class="leader-total">$${p.sales.toFixed(2)}</div>
          </div>
        `;
      }).join('');
    }
    
    function updateStats() {
      document.getElementById('statScans').textContent = stats.scans;
      document.getElementById('statSales').textContent = '$' + stats.sales.toFixed(0);
      document.getElementById('statCars').textContent = stats.cars;
      document.getElementById('statPoints').textContent = stats.points;
      document.getElementById('yourTotal').textContent = '$' + stats.sales.toFixed(2);
    }
  </script>
</body>
</html>
